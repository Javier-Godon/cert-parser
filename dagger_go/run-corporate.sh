#!/bin/bash
# Corporate pipeline runner with MITM proxy and custom CA support
# This script compiles and runs the corporate_main.go version

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check prerequisites
PROJECT_NAME=$(basename "$(cd .. && pwd)")
echo -e "${BLUE}üè¢ ${PROJECT_NAME} ‚Äî Corporate CI/CD Pipeline Runner${NC}"
echo ""

# Verify credentials
if [ ! -f "credentials/.env" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  credentials/.env not found${NC}"
    echo "   Create it with:"
    echo "   cat > credentials/.env << EOF"
    echo "   CR_PAT=your_github_token"
    echo "   USERNAME=your_github_username"
    echo "   HTTP_PROXY=http://proxy.company.com:8080"
    echo "   HTTPS_PROXY=https://proxy.company.com:8080"
    echo "   EOF"
    exit 1
fi

# Load environment
set -a
source credentials/.env
set +a

# Check for CA certificates
if [ -d "credentials/certs" ]; then
    cert_count=$(find credentials/certs -name "*.pem" 2>/dev/null | wc -l)
    if [ "$cert_count" -gt 0 ]; then
        echo -e "${GREEN}‚úì Found $cert_count CA certificate(s)${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  credentials/certs/ exists but no .pem files found${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  No credentials/certs/ directory - corporate CA support disabled${NC}"
    echo "   Create with: mkdir -p credentials/certs"
    echo "   Then copy .pem files into it"
fi

# Check proxy configuration
if [ -n "$HTTP_PROXY" ] || [ -n "$HTTPS_PROXY" ]; then
    echo -e "${GREEN}‚úì Proxy configured${NC}"
    [ -n "$HTTP_PROXY" ] && echo "   HTTP_PROXY=$HTTP_PROXY"
    [ -n "$HTTPS_PROXY" ] && echo "   HTTPS_PROXY=$HTTPS_PROXY"
else
    echo -e "${YELLOW}‚ö†Ô∏è  No proxy configured (OK if not needed)${NC}"
fi

echo ""

# Compile corporate version
echo -e "${BLUE}Compiling corporate pipeline...${NC}"

# Build with corporate build tag
if go build -tags corporate -o railway-corporate-dagger-go corporate_main.go 2>&1; then
    echo -e "${GREEN}‚úì Build successful${NC}"
else
    echo -e "${YELLOW}‚ùå Build failed${NC}"
    exit 1
fi

echo ""

# Run pipeline
echo -e "${BLUE}üöÄ Executing corporate pipeline...${NC}"
echo ""

if [ "$DEBUG_CERTS" = "true" ]; then
    echo -e "${YELLOW}Debug mode enabled - will show certificate diagnostics${NC}"
    echo ""
fi

# Execute the binary
./railway-corporate-dagger-go

echo ""
echo -e "${GREEN}‚úÖ Pipeline completed${NC}"
